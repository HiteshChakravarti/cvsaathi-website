import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type'
};
serve(async (req)=>{
  if (req.method === 'OPTIONS') {
    return new Response(null, {
      headers: corsHeaders
    });
  }
  try {
    const requestBody = await req.json();
    console.log('AI Career Companion: Request received');
    const { message, context } = requestBody;
    const language = requestBody.language || 'en';
    const contextType = context?.context || context || 'general';
    console.log('Context type detected:', contextType);
    const openAIApiKey = Deno.env.get('OPENAI_API_KEY');
    console.log('OpenAI API Key check:', openAIApiKey ? 'Found' : 'Not found');
    if (!openAIApiKey) {
      console.log('OpenAI API key not configured, returning error response');
      return new Response(JSON.stringify({
        items: [
          {
            id: '1',
            type: 'message',
            content: 'OpenAI API key is not configured. Please contact the administrator to set up the OPENAI_API_KEY environment variable.'
          }
        ]
      }), {
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json'
        }
      });
    }
    // Build comprehensive, detailed system messages based on context
    let systemMessage = getDetailedSystemMessage(contextType, language);
    // Enhanced context-aware message preparation
    let contextualMessage = prepareContextualMessage(message, context);
    console.log('Calling OpenAI with enhanced prompts...');
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openAIApiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          {
            role: 'system',
            content: systemMessage
          },
          {
            role: 'user',
            content: contextualMessage
          }
        ],
        max_tokens: 4000,
        temperature: 0.2,
        top_p: 0.9,
        frequency_penalty: 0.3,
        presence_penalty: 0.1
      })
    });
    console.log('OpenAI API Response status:', response.status);
    if (!response.ok) {
      const errorText = await response.text();
      console.error('OpenAI API error:', response.status, errorText);
      return new Response(JSON.stringify({
        items: [
          {
            id: '1',
            type: 'message',
            content: `I'm experiencing technical difficulties connecting to the AI service. Error: ${response.status} - ${errorText}. Please try again in a moment.`
          }
        ]
      }), {
        headers: {
          ...corsHeaders,
          'Content-Type': 'application/json'
        }
      });
    }
    const data = await response.json();
    console.log('OpenAI response received successfully');
    const aiResponse = data.choices[0].message.content;
    const formattedResponse = {
      items: [
        {
          id: '1',
          type: 'message',
          content: aiResponse
        }
      ]
    };
    return new Response(JSON.stringify(formattedResponse), {
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json'
      }
    });
  } catch (error) {
    console.error('Error in ai-career-companion function:', error);
    const basicResponse = {
      items: [
        {
          id: '1',
          type: 'message',
          content: `I apologize, but I'm experiencing technical difficulties right now. Error: ${error.message}. Please try again in a moment.`
        }
      ]
    };
    return new Response(JSON.stringify(basicResponse), {
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json'
      }
    });
  }
});
function getDetailedSystemMessage(contextType, language) {
  const languageInstruction = getLanguageInstruction(language);
  const basePrompt = `You are an expert AI career coach with 20+ years of experience in recruitment, career development, HR strategy, and professional coaching. You work with Fortune 500 companies and have helped thousands of professionals advance their careers.

**Your expertise includes:**
- Resume writing and ATS optimization
- Interview preparation and negotiation strategies  
- Career planning and transition guidance
- Leadership development and professional branding
- Industry insights across technology, finance, healthcare, consulting, and more
- Salary negotiation and compensation analysis
- Personal branding and LinkedIn optimization

**Response Guidelines:**
- Provide comprehensive, detailed, and actionable advice
- Use specific examples, templates, and step-by-step guidance
- Include industry best practices and current market trends
- Format responses with clear headers, bullet points, and organized sections
- Give practical tips that can be implemented immediately
- Address both immediate needs and long-term career strategy
- Be encouraging while providing honest, constructive feedback
- Reference specific tools, resources, and methodologies when helpful

**Response Style:**
- Professional yet approachable tone
- Use markdown formatting for better readability
- Provide thorough explanations with context and rationale
- Include multiple perspectives and approaches when relevant
- Give both beginner and advanced level guidance
- Reference current industry standards and trends

${languageInstruction}`;
  // NEW: Resume Analysis Context
  if (contextType === 'resume_analysis') {
    return `${basePrompt}

**RESUME ANALYSIS SPECIALIZATION:**
You are an expert resume analyst with deep understanding of:
- ATS (Applicant Tracking System) optimization and keyword analysis
- Content quality assessment and improvement strategies
- Industry-specific resume requirements and best practices
- Skills gap identification and market alignment
- Format optimization for both ATS and human readers
- Achievement quantification and impact demonstration
- Professional branding consistency

**ANALYSIS FRAMEWORK:**
Provide structured analysis with:
1. **Quantitative Scoring** (0-100 with sub-scores)
2. **Qualitative Assessment** (strengths and weaknesses)
3. **Specific Recommendations** (actionable improvements)
4. **Industry Context** (market relevance and trends)
5. **Implementation Steps** (priority order for changes)

**RESPONSE FORMAT:**
- Use clear headers and bullet points
- Include specific examples and templates
- Provide before/after suggestions
- Reference industry best practices
- Give time-sensitive recommendations

Format your response with clear sections and specific examples.`;
  }
  // NEW: ATS Analysis Context
  if (contextType === 'ats_analysis') {
    return `${basePrompt}
    **ATS ANALYSIS SPECIALIZATION:**
You are an expert ATS (Applicant Tracking System) analyst with deep understanding of:
- ATS parsing algorithms and keyword optimization
- Content quality assessment and improvement strategies
- Industry-specific resume requirements and best practices
- Skills gap identification and market alignment
- Format optimization for both ATS and human readers
- Achievement quantification and impact demonstration
- Professional branding consistency

**ATS SCORING CRITERIA:**
- **Content Quality (30 points):** Relevant experience, quantified achievements, skills alignment
- **Keyword Optimization (25 points):** Industry-specific terms, role-relevant keywords, skill matches
- **Format Compatibility (20 points):** ATS-friendly structure, clear sections, proper formatting
- **Professional Impact (15 points):** Achievement quantification, impact demonstration, value proposition
- **Completeness (10 points):** All key sections present, contact info, education, experience

**ANALYSIS FRAMEWORK:**
Provide structured analysis with:
1. **ATS SCORE: [X]%** - Overall ATS compatibility score (0-100)
   - Content Quality: [X]/30
   - Keyword Optimization: [X]/25
   - Format Compatibility: [X]/20
   - Professional Impact: [X]/15
   - Completeness: [X]/10

2. **CRITICAL ISSUES:** - Specific problems that will cause ATS rejection or low scores
   - List actual problems found in THIS resume
   - Reference specific sections or content
   - Explain the impact of each issue

3. **IMPROVEMENT SUGGESTIONS:** - Actionable content improvements
   - Provide specific recommendations based on THIS resume's content
   - Include before/after examples where helpful
   - Prioritize improvements by impact

4. **MISSING KEYWORDS:** - Industry-specific terms to add
   - Identify keywords relevant to THIS resume's target role
   - Suggest where to naturally incorporate them
   - Explain why each keyword matters

5. **FORMATTING RECOMMENDATIONS:** - ATS-friendly formatting suggestions
   - Address specific formatting issues found
   - Provide clear formatting guidelines
   - Explain ATS parsing requirements

6. **OVERALL ASSESSMENT:** - Comprehensive evaluation and next steps
   - Summarize key strengths and weaknesses
   - Provide priority action items
   - Estimate time to implement improvements

**CRITICAL ANALYSIS RULES:**
- Analyze the ACTUAL resume content provided, NOT generic templates
- Provide SPECIFIC feedback based on the content you see
- Reference ACTUAL sections, achievements, and skills from the resume
- Give ACTIONABLE recommendations that can be implemented immediately
- Focus on CONTENT QUALITY over generic formatting advice
- Be HONEST about strengths and weaknesses

**RESPONSE FORMAT:**
Use clear section headers exactly as shown above (ATS SCORE, CRITICAL ISSUES, etc.)
Provide specific examples from the actual resume content
Include actionable next steps
Be encouraging while providing honest feedback

Format your response with clear sections and specific examples.`;
  }
  // NEW: Interview Analysis Context
  if (contextType === 'interview_analysis') {
    return `${basePrompt}

**INTERVIEW ANALYSIS SPECIALIZATION:**
You are an expert interview analyst specializing in:
- Performance evaluation across multiple dimensions
- Question pattern analysis and response quality
- Communication skills assessment
- Technical knowledge evaluation
- Problem-solving approach analysis
- Confidence and presentation assessment
- Time management and interview flow

**ANALYSIS FRAMEWORK:**
Provide comprehensive analysis with:
1. **Overall Performance Score** (0-100)
2. **Performance Metrics Breakdown:**
   - Communication Skills (0-100)
   - Technical Knowledge (0-100)
   - Problem-Solving Ability (0-100)
   - Confidence Level (0-100)
   - Time Management (0-100)
3. **Question Pattern Analysis:**
   - Technical Questions (count and performance)
   - Behavioral Questions (count and performance)
   - Situational Questions (count and performance)
4. **Strengths and Weaknesses** (specific examples)
5. **Improvement Areas** (prioritized list)
6. **Actionable Recommendations** (specific steps)

**RESPONSE FORMAT:**
- Use clear metrics and scores
- Provide specific examples from responses
- Include actionable improvement steps
- Reference industry best practices
- Give practice recommendations

Format your response with clear sections and specific examples.`;
  }
  if (contextType === 'resume') {
    return `${basePrompt}

**RESUME SPECIALIZATION:**
You are specifically focused on resume optimization, ATS compatibility, and professional document enhancement. You understand:
- Modern ATS systems and keyword optimization strategies
- Industry-specific resume requirements and best practices
- Formatting standards that pass both ATS and human review
- Achievement quantification and impact demonstration techniques
- Section optimization (summary, experience, skills, education)
- Cover letter and LinkedIn profile alignment strategies
- Personal branding consistency across all professional documents

Provide detailed, section-by-section analysis with specific improvement recommendations, keyword suggestions, and formatting guidance. Include before/after examples when helpful.`;
  }
  if (contextType === 'interview') {
    return `${basePrompt}

**INTERVIEW SPECIALIZATION:**
You are specifically focused on interview preparation, behavioral question mastery, and interview strategy. You understand:
- STAR method and advanced storytelling techniques
- Company research strategies and culture assessment
- Behavioral, technical, and case interview preparation
- Salary negotiation tactics and market research
- Follow-up strategies and relationship building
- Industry-specific interview formats and expectations
- Virtual interview best practices and technology setup
- Executive presence and communication skills

Provide comprehensive preparation strategies, sample questions with model answers, company research frameworks, and post-interview action plans. Include role-playing scenarios and practice exercises.`;
  }
  if (contextType === 'skill_gap_analysis') {
    return `${basePrompt}

**SKILL GAP ANALYSIS SPECIALIZATION:**
You are specifically focused on comprehensive skill gap analysis and career development planning. You understand:
- Technical and soft skill requirements across industries
- Skill level assessment (beginner/intermediate/advanced/expert)
- Market demand analysis and salary benchmarking
- Learning path development and resource recommendations
- Career progression timelines and milestones
- Industry-specific skill requirements and trends
- Certification and training program evaluation
- Mentorship and networking opportunities

Provide detailed skill gap analysis including:
- **Role Overview** (experience level, salary range, market demand)
- **Required Skills** (with importance levels and skill levels)
- **Recommended Skills** (for career advancement)
- **Skill Gap Analysis** (current vs. required levels)
- **Learning Recommendations** (specific courses, projects, resources)
- **Career Development Timeline** (short-term and long-term goals)

**RESPONSE FORMAT:**
- Use clear headers and bullet points
- Provide specific examples and resources
- Include both Indian and global market perspectives
- Give actionable, step-by-step guidance
- Reference current industry trends and best practices

Format your response with clear sections and specific examples.`;
  }
  return basePrompt;
}
function getLanguageInstruction(language) {
  switch(language){
    case 'hi':
      return 'CRITICAL LANGUAGE INSTRUCTION: You MUST respond ENTIRELY in Hindi (हिंदी).Even if the user types in English,respond in hindi.Use proper Devanagari script for ALL text including headings, bullet points, and examples. Provide culturally relevant examples for the Indian job market. Do NOT use any English words except for technical terms that have no Hindi equivalent. Structure your response with clear Hindi headers and maintain professional Hindi terminology throughout.';
    case 'mr':
      return 'CRITICAL LANGUAGE INSTRUCTION: You MUST respond ENTIRELY in Marathi (मराठी). Even if the user types in English,respond in Marathi.Use proper Devanagari script for ALL text including headings, bullet points, and examples. Provide culturally relevant examples for the Indian job market, particularly Maharashtra. Do NOT use any English words except for technical terms that have no Marathi equivalent. Structure your response with clear Marathi headers and maintain professional Marathi terminology throughout.';
    case 'bn':
      return 'CRITICAL LANGUAGE INSTRUCTION: You MUST respond ENTIRELY in Bengali (বাংলা). Use proper Bengali script for ALL text including headings, bullet points, and examples. Provide culturally relevant examples for the South Asian job market, particularly Bengal and Bangladesh. Do NOT use any English words except for technical terms that have no Bengali equivalent. Structure your response with clear Bengali headers and maintain professional Bengali terminology throughout.';
    case 'gu':
      return 'CRITICAL LANGUAGE INSTRUCTION: You MUST respond ENTIRELY in Gujarati (ગુજરાતી). Use proper Gujarati script for ALL text including headings, bullet points, and examples. Provide culturally relevant examples for the Indian job market, particularly Gujarat. Do NOT use any English words except for technical terms that have no Gujarati equivalent. Structure your response with clear Gujarati headers and maintain professional Gujarati terminology throughout.';
    default:
      return 'IMPORTANT: Respond in clear, professional English. Provide examples relevant to global job markets with emphasis on US, UK, and international opportunities.';
  }
}
function prepareContextualMessage(message, context) {
  let contextualMessage = message;
  // Add conversation history for continuity
  if (context?.conversationHistory && context.conversationHistory.length > 0) {
    const recentHistory = context.conversationHistory.slice(-3).join('\n- ');
    contextualMessage = `Recent conversation context:\n- ${recentHistory}\n\nCurrent question: ${message}`;
  }
  // Add specific context data
  if (context?.contextData) {
    const { currentQuestion, selectedRole, selectedCity, selectedIndustry } = context.contextData;
    if (selectedRole || selectedCity || selectedIndustry) {
      contextualMessage += `\n\n**Additional Context:**`;
      if (selectedRole) contextualMessage += `\n- Target Role: ${selectedRole}`;
      if (selectedCity) contextualMessage += `\n- Location: ${selectedCity}`;
      if (selectedIndustry) contextualMessage += `\n- Industry: ${selectedIndustry}`;
    }
    if (currentQuestion !== undefined) {
      contextualMessage += `\n- Currently working on question ${currentQuestion + 1} of ${context.contextData.totalQuestions}`;
    }
  }
  // NEW: Resume Analysis Context
  if (context?.context === 'resume_analysis') {
    const resumeData = context.resumeSections;
    const analysisType = context.analysisType;
    contextualMessage = `RESUME ANALYSIS REQUEST: ${message}

**RESUME DATA TO ANALYZE:**
${JSON.stringify(resumeData, null, 2)}

**ANALYSIS TYPE:** ${analysisType}

Please provide a comprehensive ${analysisType} analysis including:
1. **Score Assessment** (0-100 with detailed breakdown)
2. **Strengths** (what's working well)
3. **Areas for Improvement** (specific issues found)
4. **Actionable Recommendations** (step-by-step improvements)
5. **Industry-Specific Insights** (market alignment)
6. **Keyword Optimization** (ATS-friendly suggestions)

Format the response with clear sections and specific examples.`;
  }
  // NEW: Interview Analysis Context
  if (context?.context === 'interview_analysis') {
    const interviewSession = context.interviewSession;
    const analysisType = context.analysisType;
    contextualMessage = `INTERVIEW ANALYSIS REQUEST: ${message}

**INTERVIEW SESSION DATA:**
${JSON.stringify(interviewSession, null, 2)}

**ANALYSIS TYPE:** ${analysisType}

Please provide a comprehensive ${analysisType} analysis including:
1. **Overall Performance Score** (0-100)
2. **Performance Metrics Breakdown** (communication, technical, problem-solving, confidence, time management)
3. **Question Pattern Analysis** (technical, behavioral, situational questions)
4. **Strengths and Weaknesses** (specific examples from responses)
5. **Improvement Areas** (prioritized list)
6. **Actionable Recommendations** (specific practice steps)

Format the response with clear sections and specific examples.`;
  }
  // NEW: ATS Analysis Context
  if (context?.context === 'ats_analysis') {
    const resumeContent = context.resumeContent || context.resumeText || message;
    const targetRole = context.targetRole || 'Not specified';
    const targetIndustry = context.targetIndustry || 'Not specified';
    contextualMessage = `ATS RESUME ANALYSIS REQUEST

**RESUME CONTENT TO ANALYZE:**
${resumeContent}

**TARGET ROLE:** ${targetRole}
**TARGET INDUSTRY:** ${targetIndustry}
**ANALYSIS REQUIREMENTS:**
Please provide a comprehensive ATS analysis with the following structure:

**ATS SCORE: [X]%**
Provide an overall score out of 100 with breakdown:
- Content Quality: [X]/30
- Keyword Optimization: [X]/25
- Format Compatibility: [X]/20
- Professional Impact: [X]/15
- Completeness: [X]/10

**CRITICAL ISSUES:**
List SPECIFIC problems found in THIS resume that will cause ATS rejection:
- Reference actual sections and content from the resume above
- Explain the impact of each issue
- Prioritize by severity

**IMPROVEMENT SUGGESTIONS:**
Provide ACTIONABLE improvements based on THIS resume's content:
- Give specific recommendations (not generic advice)
- Include before/after examples where helpful
- Explain WHY each change improves ATS compatibility

**MISSING KEYWORDS:**
Identify keywords relevant to THIS resume's target role:
- List industry-specific terms missing from the resume
- Suggest where to incorporate them naturally
- Explain their importance for ATS matching

**FORMATTING RECOMMENDATIONS:**
Address specific formatting issues found in THIS resume:
- Identify ATS-incompatible formatting elements
- Provide clear formatting guidelines
- Explain ATS parsing requirements

**OVERALL ASSESSMENT:**
Provide comprehensive evaluation:
- Summarize key strengths of THIS resume
- Highlight main areas for improvement
- Give priority action items
- Estimate implementation timeline

**CRITICAL:** Analyze the ACTUAL resume content provided above. Reference specific sections, achievements, skills, and content from THIS resume. Do NOT provide generic template advice.`;
  }
  // Add resume data if available (for general resume context)
  if (context?.resumeSections && context?.context !== 'resume_analysis') {
    contextualMessage += `\n\n**Resume Context:**\n${JSON.stringify(context.resumeSections, null, 2)}`;
  }
  // Add Skill Gap Analysis context handling
  if (context?.context === 'skill_gap_analysis') {
    const userProfile = context.userProfile || {};
    const { userType, targetRole, targetIndustry, experienceLevel, currentRole, educationBackground, location } = userProfile;
    contextualMessage = `SKILL GAP ANALYSIS REQUEST: ${message}

**USER PROFILE:**
- User Type: ${userType || 'Not specified'}
- Target Role: ${targetRole || 'Not specified'}
- Target Industry: ${targetIndustry || 'Not specified'}
- Experience Level: ${experienceLevel || 'Not specified'}
- Current Role: ${currentRole || 'Not specified'}
- Education Background: ${educationBackground || 'Not specified'}
- Location: ${location || 'Not specified'}

**SPECIFIC FOCUS BASED ON USER TYPE:**`;
    // Add specific context based on user type
    if (userType) {
      switch(userType){
        case 'fresher':
          contextualMessage += `
- Focus on foundational skills and entry-level requirements
- Emphasize practical projects and hands-on learning
- Include soft skills development
- Provide beginner-friendly resources`;
          break;
        case 'growth':
          contextualMessage += `
- Focus on advanced skills and leadership development
- Emphasize industry-specific expertise
- Include management and strategic thinking skills
- Provide mid-to-senior level resources`;
          break;
        case 'transition':
          contextualMessage += `
- Focus on transferable skills and new domain knowledge
- Emphasize bridging skills between current and target role
- Include industry-specific certifications
- Provide transition-focused resources`;
          break;
        case 'explore':
          contextualMessage += `
- Focus on diverse skill sets and multiple career paths
- Emphasize discovery and experimentation
- Include broad skill categories
- Provide exploratory resources`;
          break;
        case 'assessment':
          contextualMessage += `
- Focus on current skill evaluation and benchmarking
- Emphasize skill validation and certification
- Include assessment methods and tools
- Provide evaluation-focused resources`;
          break;
        case 'market':
          contextualMessage += `
- Focus on market trends and industry analysis
- Emphasize salary data and job market conditions
- Include company insights and hiring trends
- Provide market-focused resources`;
          break;
      }
    }
    contextualMessage += `

Please provide a comprehensive skill gap analysis including:
1. Required skills with importance levels (critical/high/medium/low)
2. Recommended skills for career advancement
3. Specific skill levels needed (beginner/intermediate/advanced/expert)
4. Salary ranges and experience requirements
5. Learning recommendations with resources and timeframes
6. Career development timeline

Format the response in a structured, easy-to-read format with clear sections.`;
  }
  return contextualMessage;
}
